<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIAMO TAF-METAR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7fa3d8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .input-group textarea {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .input-group textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        .button-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .verify-btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 1.2em;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(42, 82, 152, 0.4);
        }

        .verify-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(42, 82, 152, 0.6);
        }

        .verify-btn:active {
            transform: translateY(0);
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
            display: none;
        }

        .success-message {
            background: #efe;
            color: #3a3;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #3a3;
            display: none;
        }

        .results {
            display: none;
        }

        .station-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .station-info h3 {
            color: #2a5298;
            font-size: 1.5em;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card h4 {
            color: #555;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #1565c0;
        }

        .metric-card .na {
            font-size: 2em;
            color: #999;
        }

        .overall-accuracy {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .overall-accuracy h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .overall-accuracy .value {
            font-size: 3.5em;
            font-weight: bold;
        }

        .compliance-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        .compliance-section h3 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
        }

        .compliance-badge {
            display: inline-block;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .compliance-badge.compliant {
            background: #d4edda;
            color: #155724;
            border: 3px solid #28a745;
        }

        .compliance-badge.non-compliant {
            background: #f8d7da;
            color: #721c24;
            border: 3px solid #dc3545;
        }

        .compliance-details {
            text-align: left;
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .compliance-details h4 {
            color: #721c24;
            margin-bottom: 15px;
        }

        .compliance-details ul {
            list-style: none;
        }

        .compliance-details li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .input-section {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>KIAMO TAF‚ÄìMETAR</h1>
            <p>TAF‚ÄìMETAR Parsing & ICAO Accuracy Verification</p>
        </div>

        <div class="main-content">
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <div class="input-section">
                <div class="input-group">
                    <label for="tafInput">Paste TAF Report</label>
                    <textarea 
                        id="tafInput" 
                        placeholder="TAF DGAA 291100Z 2912/3012 27015KT 9999 FEW020 BKN040..."
                    ></textarea>
                </div>
                <div class="input-group">
                    <label for="metarInput">Paste METAR Report</label>
                    <textarea 
                        id="metarInput" 
                        placeholder="METAR DGAA 291130Z 28012KT 9999 FEW018 BKN038 28/22 Q1013..."
                    ></textarea>
                </div>
            </div>

            <div class="button-container">
                <button class="verify-btn" onclick="verifyAccuracy()">Verify Accuracy</button>
            </div>

            <div class="results" id="results">
                <div class="station-info" id="stationInfo"></div>

                <h2 style="margin-bottom: 20px; color: #333;">üìä Per-Parameter Accuracy Scores</h2>
                <div class="metrics-grid" id="metricsGrid"></div>

                <h2 style="margin-bottom: 20px; color: #333;">üìà Overall Accuracy</h2>
                <div class="overall-accuracy" id="overallAccuracy"></div>

                <div class="compliance-section" id="complianceSection"></div>
            </div>
        </div>

        <div class="footer">
            KIAMO TAF-METAR v1.0 | ICAO-Compliant Forecast Verification
        </div>
    </div>

    <script>
        // Parser Module
        const Parser = {
            extractStation(reportText) {
                const tokens = reportText.split(/\s+/);
                const icaoPattern = /^[A-Z]{4}$/;
                
                for (let i = 0; i < Math.min(2, tokens.length); i++) {
                    if (icaoPattern.test(tokens[i])) {
                        return tokens[i];
                    }
                }
                return null;
            },

            parseWind(reportText) {
                const windPattern = /\b(\d{3}|VRB)(\d{2,3})(G\d{2,3})?KT\b/;
                const match = reportText.match(windPattern);
                
                if (match) {
                    const directionStr = match[1];
                    const speed = parseInt(match[2]);
                    
                    let direction = null;
                    if (directionStr !== 'VRB' && directionStr !== '000') {
                        direction = parseInt(directionStr);
                    }
                    
                    return { direction, speed };
                }
                
                return { direction: null, speed: null };
            },

            parseVisibility(reportText) {
                if (reportText.includes('CAVOK')) {
                    return 10000;
                }
                
                const visPattern = /\b(\d{4})\b/g;
                const tokens = reportText.split(/\s+/);
                
                for (const token of tokens) {
                    if (/^\d{4}$/.test(token)) {
                        const vis = parseInt(token);
                        if (vis <= 9999 || vis === 10000) {
                            return vis;
                        }
                    }
                }
                
                return null;
            },

            parseClouds(reportText) {
                if (reportText.includes('CAVOK')) {
                    return { amount: 'CAVOK', height: 5000 };
                }
                
                const nscTypes = ['NSC', 'NCD', 'SKC'];
                for (const nsc of nscTypes) {
                    if (reportText.includes(nsc)) {
                        return { amount: nsc, height: 5000 };
                    }
                }
                
                const cloudPattern = /\b(FEW|SCT|BKN|OVC|VV)(\d{3})\b/g;
                const matches = [...reportText.matchAll(cloudPattern)];
                
                if (matches.length > 0) {
                    const lowest = matches.reduce((min, curr) => {
                        return parseInt(curr[2]) < parseInt(min[2]) ? curr : min;
                    });
                    
                    return {
                        amount: lowest[1],
                        height: parseInt(lowest[2]) * 100
                    };
                }
                
                return { amount: null, height: null };
            },

            parse(reportText) {
                const wind = this.parseWind(reportText);
                const visibility = this.parseVisibility(reportText);
                const clouds = this.parseClouds(reportText);
                
                return {
                    wind_direction: wind.direction,
                    wind_speed: wind.speed,
                    visibility: visibility,
                    cloud_amount: clouds.amount,
                    cloud_height: clouds.height
                };
            }
        };

        // Scoring Module
        const Scoring = {
            scoreWindDirection(tafDir, metarDir) {
                if (tafDir === null || metarDir === null) return null;
                
                const diff = Math.abs(tafDir - metarDir);
                const circularDiff = Math.min(diff, 360 - diff);
                
                if (circularDiff <= 50) return 100.0;
                if (circularDiff <= 120) return 50.0;
                return 0.0;
            },

            scoreWindSpeed(tafSpeed, metarSpeed) {
                if (tafSpeed === null || metarSpeed === null) return null;
                
                const diff = Math.abs(tafSpeed - metarSpeed);
                
                if (diff <= 2) return 100.0;
                if (diff <= 5) return 70.0;
                if (diff <= 10) return 50.0;
                if (diff <= 15) return 20.0;
                return 0.0;
            },

            scoreVisibility(tafVis, metarVis) {
                if (tafVis === null || metarVis === null) return null;
                
                const diff = Math.abs(tafVis - metarVis);
                
                if (diff <= 500) return 100.0;
                if (diff <= 1000) return 80.0;
                if (diff <= 4000) return 70.0;
                if (diff <= 8000) return 30.0;
                return 0.0;
            },

            scoreCloudHeight(tafHeight, metarHeight) {
                if (tafHeight === null || metarHeight === null) return null;
                
                const diff = Math.abs(tafHeight - metarHeight);
                
                if (diff <= 500) return 100.0;
                if (diff <= 1000) return 70.0;
                if (diff <= 2000) return 50.0;
                if (diff <= 3000) return 10.0;
                return 0.0;
            },

            scoreCloudAmount(tafAmount, metarAmount) {
                if (tafAmount === null || metarAmount === null) return null;
                
                const clearFewSct = ['NSC', 'NCD', 'SKC', 'FEW', 'SCT', 'CAVOK'];
                const brokenOvercast = ['BKN', 'OVC'];
                
                if (clearFewSct.includes(tafAmount) && clearFewSct.includes(metarAmount)) {
                    return 100.0;
                }
                
                if (brokenOvercast.includes(tafAmount) && brokenOvercast.includes(metarAmount)) {
                    return 100.0;
                }
                
                if (clearFewSct.includes(tafAmount) && brokenOvercast.includes(metarAmount)) {
                    return 10.0;
                }
                
                if (brokenOvercast.includes(tafAmount) && clearFewSct.includes(metarAmount)) {
                    return 30.0;
                }
                
                if (tafAmount === 'VV' || metarAmount === 'VV') {
                    if (brokenOvercast.includes(tafAmount) || brokenOvercast.includes(metarAmount)) {
                        return 100.0;
                    }
                    return 30.0;
                }
                
                return 0.0;
            },

            computeScores(tafData, metarData) {
                return {
                    wind_direction: this.scoreWindDirection(tafData.wind_direction, metarData.wind_direction),
                    wind_speed: this.scoreWindSpeed(tafData.wind_speed, metarData.wind_speed),
                    visibility: this.scoreVisibility(tafData.visibility, metarData.visibility),
                    cloud_amount: this.scoreCloudAmount(tafData.cloud_amount, metarData.cloud_amount),
                    cloud_height: this.scoreCloudHeight(tafData.cloud_height, metarData.cloud_height)
                };
            }
        };

        // Verification Module
        const Verification = {
            computeOverallAccuracy(scores) {
                const validScores = Object.values(scores).filter(s => s !== null);
                if (validScores.length === 0) return 0.0;
                return validScores.reduce((a, b) => a + b, 0) / validScores.length;
            },

            verifyICAOCompliance(scores) {
                const thresholds = {
                    wind_direction: 80.0,
                    wind_speed: 80.0,
                    visibility: 80.0,
                    cloud_amount: 70.0,
                    cloud_height: 70.0
                };

                const complianceDetails = {};
                let allPassed = true;

                for (const [param, threshold] of Object.entries(thresholds)) {
                    const score = scores[param];
                    const passed = score !== null && score >= threshold;
                    
                    if (!passed) allPassed = false;
                    
                    complianceDetails[param] = {
                        score: score !== null ? score : 0.0,
                        threshold: threshold,
                        passed: passed
                    };
                }

                return { isCompliant: allPassed, details: complianceDetails };
            }
        };

        // UI Functions
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('results').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = '‚úÖ ' + message;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function displayResults(station, scores, overallAccuracy, compliance) {
            document.getElementById('results').style.display = 'block';
            
            // Station info
            document.getElementById('stationInfo').innerHTML = `
                <h3>Detected Station: ${station}</h3>
            `;

            // Metrics grid
            const metricsGrid = document.getElementById('metricsGrid');
            const metrics = [
                { key: 'wind_direction', label: 'Wind Direction' },
                { key: 'wind_speed', label: 'Wind Speed' },
                { key: 'visibility', label: 'Visibility' },
                { key: 'cloud_amount', label: 'Cloud Amount' },
                { key: 'cloud_height', label: 'Cloud Height' }
            ];

            metricsGrid.innerHTML = metrics.map(metric => {
                const score = scores[metric.key];
                const valueHtml = score !== null 
                    ? `<div class="value">${score.toFixed(1)}%</div>`
                    : `<div class="na">N/A</div>`;
                
                return `
                    <div class="metric-card">
                        <h4>${metric.label}</h4>
                        ${valueHtml}
                    </div>
                `;
            }).join('');

            // Overall accuracy
            document.getElementById('overallAccuracy').innerHTML = `
                <h3>Average Score</h3>
                <div class="value">${overallAccuracy.toFixed(1)}%</div>
            `;

            // Compliance section
            const complianceSection = document.getElementById('complianceSection');
            const badgeClass = compliance.isCompliant ? 'compliant' : 'non-compliant';
            const badgeText = compliance.isCompliant ? '‚úÖ ICAO COMPLIANT' : '‚ùå NON-COMPLIANT';
            
            let detailsHtml = '';
            if (!compliance.isCompliant) {
                const failedParams = Object.entries(compliance.details)
                    .filter(([_, details]) => !details.passed)
                    .map(([param, details]) => {
                        const label = param.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        return `<li><strong>${label}:</strong> ${details.score.toFixed(1)}% (Required: ‚â•${details.threshold}%)</li>`;
                    });
                
                detailsHtml = `
                    <div class="compliance-details">
                        <h4>The following parameters failed ICAO thresholds:</h4>
                        <ul>${failedParams.join('')}</ul>
                    </div>
                `;
            } else {
                detailsHtml = `
                    <p style="color: #155724; margin-top: 10px;">
                        All parameters meet their respective ICAO minimum thresholds.
                    </p>
                `;
            }

            complianceSection.innerHTML = `
                <h3>üîç ICAO Compliance Status</h3>
                <div class="compliance-badge ${badgeClass}">${badgeText}</div>
                ${detailsHtml}
            `;

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function verifyAccuracy() {
            const tafText = document.getElementById('tafInput').value.trim().toUpperCase();
            const metarText = document.getElementById('metarInput').value.trim().toUpperCase();

            // Validation
            if (!tafText || !metarText) {
                showError('Please provide both TAF and METAR reports.');
                return;
            }

            // Extract stations
            const tafStation = Parser.extractStation(tafText);
            const metarStation = Parser.extractStation(metarText);

            if (!tafStation) {
                showError('Could not detect ICAO station from TAF report.');
                return;
            }

            if (!metarStation) {
                showError('Could not detect ICAO station from METAR report.');
                return;
            }

            if (tafStation !== metarStation) {
                showError(`Station mismatch! TAF station: ${tafStation}, METAR station: ${metarStation}`);
                return;
            }

            showSuccess(`Detected Station: ${tafStation}`);

            // Parse reports
            const tafData = Parser.parse(tafText);
            const metarData = Parser.parse(metarText);

            // Compute scores
            const scores = Scoring.computeScores(tafData, metarData);
            const overallAccuracy = Verification.computeOverallAccuracy(scores);
            const compliance = Verification.verifyICAOCompliance(scores);

            // Display results
            displayResults(tafStation, scores, overallAccuracy, compliance);
        }

        // Allow Enter key to trigger verification
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = [document.getElementById('tafInput'), document.getElementById('metarInput')];
            inputs.forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        verifyAccuracy();
                    }
                });
            });
        });
    </script>
</body>
</html>